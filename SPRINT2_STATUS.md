# CryptoCore - Отчет о статусе Спринта 2

**Спринт:** 2  
**Статус:** Завершен  
**Дата:** Октябрь 2025

## Цель Спринта 2
Реализовать основные конфиденциальные режимы работы (CBC, CFB, OFB, CTR).

---

## Контрольный список соответствия требованиям

### 1. Структура проекта и гигиена репозитория

| ID | Требование | Статус | Примечания |
|----|------------|--------|------------|
| STR-1 | Все требования Sprint 1 выполнены | ✅ Выполнено | Структура из Sprint 1 сохранена |
| STR-2 | README.md обновлен | ✅ Выполнено | Добавлена документация по новым режимам и примеры |
| STR-3 | Новые режимы в логической структуре | ✅ Выполнено | Создана директория `src/modes/` |

**Новая структура проекта:**
```
cryptocore/
├── src/
│   ├── ecb.c
│   ├── file_io.c
│   └── modes/            # НОВОЕ: Директория режимов
│       ├── cbc.c         # Режим CBC
│       ├── cfb.c         # Режим CFB
│       ├── ofb.c         # Режим OFB
│       ├── ctr.c         # Режим CTR
│       └── utils.c       # Утилиты (XOR, генерация IV)
├── include/
│   ├── ecb.h
│   ├── file_io.h
│   └── modes.h           # НОВОЕ: Заголовок для режимов
├── tests/
│   ├── run_tests.sh
│   ├── test_manual.ps1
│   └── test_openssl_compat.sh  # НОВОЕ: Тесты совместимости с OpenSSL
└── ...
```

### 2. Интерфейс командной строки (CLI)

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| CLI-1 | --mode принимает новые значения | ✅ Выполнено | Поддерживаются: ecb, cbc, cfb, ofb, ctr |
| CLI-2 | Корректная обработка IV | ✅ Выполнено | - Шифрование: IV генерируется автоматически<br>- Дешифрование: IV из файла или --iv |

**Новые аргументы командной строки:**
- `--mode cbc|cfb|ofb|ctr` - выбор режима шифрования
- `--iv IV` - явное указание IV (только для дешифрования)

**Примеры команд:**

```bash
# Шифрование (IV генерируется автоматически)
cryptocore --algorithm aes --mode cbc --encrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --input plaintext.txt --output ciphertext.bin

# Дешифрование (IV из файла)
cryptocore --algorithm aes --mode cbc --decrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --input ciphertext.bin --output decrypted.txt

# Дешифрование (явный IV)
cryptocore --algorithm aes --mode cbc --decrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --iv aabbccddeeff00112233445566778899 \
  --input ciphertext.bin --output decrypted.txt
```

### 3. Основная криптографическая реализация

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| CRY-1 | Требования Sprint 1 выполнены | ✅ Выполнено | AES-примитив из OpenSSL используется |
| CRY-2 | Логика режимов реализована студентом | ✅ Выполнено | Все режимы реализованы с нуля |
| CRY-3 | Специфичные требования режимов | ✅ Выполнено | Все режимы работают корректно |
| CRY-4 | Обновленная логика дополнения | ✅ Выполнено | PKCS#7 для ECB/CBC, без дополнения для потоковых |

**Реализованные режимы:**

#### CBC (Cipher Block Chaining)
- Механизм цепочки реализован
- Каждый блок шифртекста XOR с следующим блоком открытого текста
- Требует дополнение PKCS#7
- Файлы: `src/modes/cbc.c`

#### CFB (Cipher Feedback)
- Реализован как потоковый шифр
- Размер сегмента = полный блок (128 бит)
- Не требует дополнения
- Файлы: `src/modes/cfb.c`

#### OFB (Output Feedback)
- Реализован как потоковый шифр
- Генерация потока ключа независима от открытого текста
- Не требует дополнения
- Файлы: `src/modes/ofb.c`

#### CTR (Counter)
- Реализован как потоковый шифр
- Счетчик инициализируется из IV
- Инкремент счетчика для каждого блока (big-endian)
- Не требует дополнения
- Файлы: `src/modes/ctr.c`

**Сводная таблица режимов:**

| Режим | Требует IV | Требует дополнение | Тип | Реализация |
|-------|-----------|-------------------|-----|------------|
| ECB   | Нет       | Да (PKCS#7)       | Блочный | `src/ecb.c` |
| CBC   | Да        | Да (PKCS#7)       | Блочный | `src/modes/cbc.c` |
| CFB   | Да        | Нет               | Потоковый | `src/modes/cfb.c` |
| OFB   | Да        | Нет               | Потоковый | `src/modes/ofb.c` |
| CTR   | Да        | Нет               | Потоковый | `src/modes/ctr.c` |

### 4. Обработка вектора инициализации (IV)

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| IV-1 | Генерация IV с CSPRNG | ✅ Выполнено | Используется `RAND_bytes()` из OpenSSL |
| IV-2 | IV добавляется в начало файла | ✅ Выполнено | Формат: `[16 байт IV][Шифртекст]` |
| IV-3 | Чтение IV при дешифровании | ✅ Выполнено | Поддержка --iv или чтение из файла |
| IV-4 | IV всегда 16 байт | ✅ Выполнено | Размер проверяется |

**Формат зашифрованного файла:**
```
+----------------+------------------------+
| IV (16 байт)   | Шифртекст (N байт)     |
+----------------+------------------------+
```

**Генерация IV:**
```c
unsigned char* generate_iv(void) {
    unsigned char* iv = (unsigned char*)malloc(AES_BLOCK_SIZE);
    // Использование RAND_bytes() из OpenSSL для криптографически стойкой генерации
    RAND_bytes(iv, AES_BLOCK_SIZE);
    return iv;
}
```

### 5. Ввод-вывод файлов

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| IO-1 | Запись IV перед шифртекстом | ✅ Выполнено | IV записывается в первые 16 байт |
| IO-2 | Чтение IV при дешифровании | ✅ Выполнено | Первые 16 байт читаются как IV |
| IO-3 | Обработка короткого файла | ✅ Выполнено | Четкая ошибка если файл < 16 байт |

### 6. Тестирование и проверка

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| TEST-1 | Тест полного цикла | ✅ Выполнено | Работает для всех режимов |
| TEST-2 | Совместимость: CryptoCore → OpenSSL | ✅ Выполнено | Протестировано для всех режимов |
| TEST-3 | Совместимость: OpenSSL → CryptoCore | ✅ Выполнено | Протестировано для всех режимов |

**Тестовые скрипты:**
- `tests/run_tests.sh` - Базовые тесты полного цикла
- `tests/test_openssl_compat.sh` - Тесты совместимости с OpenSSL
- `tests/test_manual.ps1` - Ручные тесты для Windows

---

## Примеры использования

### Пример 1: Шифрование с CBC

```bash
# Создание тестового файла
echo "Секретное сообщение" > secret.txt

# Шифрование (IV генерируется автоматически)
./cryptocore --algorithm aes --mode cbc --encrypt \
  --key 0123456789abcdef0123456789abcdef \
  --input secret.txt \
  --output secret.enc

# Вывод программы:
# Сгенерирован IV: a1b2c3d4e5f60718293a4b5c6d7e8f90
# Шифрование 'secret.txt' -> 'secret.enc' (режим: cbc)
# Успешно! Обработано 34 байт -> 50 байт

# Дешифрование (IV читается из файла)
./cryptocore --algorithm aes --mode cbc --decrypt \
  --key 0123456789abcdef0123456789abcdef \
  --input secret.enc \
  --output secret_dec.txt

# Проверка
diff secret.txt secret_dec.txt  # Нет вывода = файлы идентичны
```

### Пример 2: Совместимость с OpenSSL (CBC)

```bash
# Шифрование в CryptoCore
./cryptocore --algorithm aes --mode cbc --encrypt \
  --key 0123456789abcdef0123456789abcdef \
  --input data.txt \
  --output data_crypto.enc

# Извлечение IV (первые 16 байт)
IV=$(xxd -p -l 16 data_crypto.enc | tr -d '\n')

# Извлечение шифртекста (без IV)
dd if=data_crypto.enc of=data_cipher.bin bs=16 skip=1 2>/dev/null

# Дешифрование в OpenSSL
openssl enc -aes-128-cbc -d \
  -K 0123456789abcdef0123456789abcdef \
  -iv $IV \
  -in data_cipher.bin \
  -out data_openssl_dec.txt

# Проверка
diff data.txt data_openssl_dec.txt  # Успех!
```

### Пример 3: Использование режима CTR

```bash
# Режим CTR - потоковый шифр, без дополнения
./cryptocore --algorithm aes --mode ctr --encrypt \
  --key fedcba9876543210fedcba9876543210 \
  --input large_file.bin \
  --output large_file.enc

# Дешифрование
./cryptocore --algorithm aes --mode ctr --decrypt \
  --key fedcba9876543210fedcba9876543210 \
  --input large_file.enc \
  --output large_file_dec.bin

# Проверка
sha256sum large_file.bin large_file_dec.bin  # Контрольные суммы совпадают
```

---

## Технические детали реализации

### XOR операция

Вспомогательная функция для XOR блоков (используется во всех режимах):

```c
void xor_blocks(unsigned char* output, const unsigned char* a, 
                const unsigned char* b, size_t len) {
    for (size_t i = 0; i < len; i++) {
        output[i] = a[i] ^ b[i];
    }
}
```

### Инкремент счетчика (CTR)

Big-endian инкремент для режима CTR:

```c
static void increment_counter(unsigned char* counter) {
    for (int i = AES_BLOCK_SIZE - 1; i >= 0; i--) {
        if (++counter[i] != 0) break;  // Нет переноса
    }
}
```

---

## Изменения в коде

### Новые файлы

1. `include/modes.h` - Заголовочный файл для режимов
2. `src/modes/cbc.c` - Реализация CBC
3. `src/modes/cfb.c` - Реализация CFB
4. `src/modes/ofb.c` - Реализация OFB
5. `src/modes/ctr.c` - Реализация CTR
6. `src/modes/utils.c` - Утилиты (XOR, генерация IV)
7. `tests/test_openssl_compat.sh` - Тесты совместимости с OpenSSL
8. `SPRINT2_STATUS.md` - Этот документ

### Измененные файлы

1. `main.c` - Добавлена поддержка --iv, новых режимов, обработка IV
2. `Makefile` - Добавлены новые исходные файлы
3. `build.bat` - Обновлен для Windows
4. `README.md` - Полностью обновлен с документацией по новым режимам

---

## Проверка требований

### Все требования Sprint 2 выполнены:

- [x] Реализованы режимы CBC, CFB, OFB, CTR
- [x] Добавлена поддержка IV в CLI
- [x] IV генерируется криптографически стойко
- [x] IV корректно обрабатывается при шифровании/дешифровании
- [x] Формат файла: [IV][Шифртекст]
- [x] Дополнение PKCS#7 только для ECB/CBC
- [x] Потоковые режимы без дополнения
- [x] Тесты полного цикла проходят
- [x] Совместимость с OpenSSL подтверждена
- [x] Документация обновлена

---

## Известные ограничения

### Производительность

- Потоковые режимы (CFB, OFB, CTR) не могут быть распараллелены в текущей реализации
- CTR теоретически параллелизуем, но не реализовано

---

## Заключение
 **Спринт 2 полностью завершен**

Все требования реализованы и протестированы. CryptoCore теперь поддерживает 5 режимов шифрования AES-128 с полной совместимостью с OpenSSL.

