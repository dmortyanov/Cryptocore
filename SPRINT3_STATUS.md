# CryptoCore - Отчет о статусе Спринта 3

**Спринт:** 3  
**Статус:** ✅ Завершен  
**Дата:** Октябрь 2025

## Цель Спринта 3
Реализовать криптографически стойкий источник случайности (CSPRNG) для генерации ключей и IV, а также расширить CLI для автоматической генерации ключа при шифровании, когда `--key` не указан.

---

## Контрольный список соответствия требованиям

### 1. Структура проекта и гигиена репозитория

| ID | Требование | Статус | Примечания |
|----|------------|--------|------------|
| STR-1 | Все требования предыдущих спринтов (STR-1…STR-4) выполнены | ✅ Выполнено | Спринты 1–2 сохранены без регрессий |
| STR-2 | Создан новый модуль CSPRNG | ✅ Выполнено | `src/csprng.c`, `include/csprng.h` |
| STR-3 | README обновлен требованиями спринта | ✅ Выполнено | Поведение без `--key`, пример, свойства CSPRNG, инструкции NIST STS |

### 2. Интерфейс командной строки (CLI)

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| CLI-1 | `--key` опционален при шифровании | ✅ Выполнено | При шифровании без `--key` генерируется новый ключ |
| CLI-2 | Если `--key` задан, используется без изменений | ✅ Выполнено | Проверка формата: 32 hex-символа (AES-128) |
| CLI-3 | Если `--key` не задан при шифровании: сгенерировать, вывести и использовать | ✅ Выполнено | Вывод в stdout: `[INFO] Generated random key: <32-hex>` |
| CLI-4 | При дешифровании `--key` обязателен | ✅ Выполнено | При отсутствии ключа – четкая ошибка |
| CLI-5 | Предупреждение о «слабых» ключах (Should) | ✅ Выполнено | `stderr` предупреждение: все нули, последовательности, повторяющиеся паттерны |

### 3. Криптографически стойкая генерация случайных чисел (CSPRNG)

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| RNG-1 | Выделенный модуль CSPRNG | ✅ Выполнено | `src/csprng.c`, `include/csprng.h` |
| RNG-2 | Основная функция генерации байтов | ✅ Выполнено | `int generate_random_bytes(unsigned char*, size_t)` |
| RNG-3 | Использовать vetted источник ОС/библиотеки | ✅ Выполнено | OpenSSL `RAND_bytes()` (системный CSPRNG ОС) |
| RNG-4 | Не использовать небезопасные `rand()` и т.п. | ✅ Выполнено | Только `RAND_bytes()` |
| RNG-5 | Интеграция в ключи и IV | ✅ Выполнено | `generate_aes_key()`, `generate_random_iv()` используются в шифровании |

### 4. Управление IV (неизменность требований Sprint 2)

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| IV-1 | Генерация IV с CSPRNG | ✅ Выполнено | `generate_random_iv()` → `RAND_bytes()` |
| IV-2 | IV добавляется в начало выходного файла | ✅ Выполнено | Формат: `[16 байт IV][Шифртекст]` |
| IV-3 | Дешифрование: IV из CLI или из файла | ✅ Выполнено | Если `--iv` нет, считываем первые 16 байт |
| IV-4 | IV = 16 байт для всех режимов | ✅ Выполнено | Проверка длины |

### 5. Управление ключами

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| KEY-1 | Сгенерированный ключ = 16 байт (AES-128) | ✅ Выполнено | `generate_aes_key()` |
| KEY-2 | Ключ печатается в stdout один раз, hex | ✅ Выполнено | `[INFO] Generated random key: <hex>` |
| KEY-3 | Не записывать ключ в файл шифртекста | ✅ Выполнено | Ключ выводится только в консоль |

### 6. Тестирование и проверка

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| TEST-1 | Шифрование без `--key` генерирует ключ, расшифр. этим ключом | ✅ Выполнено | Примеры в README; поведение проверено вручную |
| TEST-2 | Тест уникальности: 1000 ключей уникальны | ✅ Выполнено | `tests/test_csprng_uniqueness.sh` (проверка уникальности + базовая статистика) |
| TEST-3 | NIST STS: подготовка данных и инструкции | ✅ Выполнено | `tests/generate_nist_data.sh` (10 МБ), инструкции в README |
| TEST-4 | Совместимость с OpenSSL (из Sprint 2) | ✅ Выполнено | CLI по-прежнему поддерживает `--key/--iv`; примеры в README |

---

## Изменения в коде

### Новые файлы
1. `include/csprng.h` – Заголовок CSPRNG
2. `src/csprng.c` – Реализация CSPRNG (OpenSSL `RAND_bytes()`)
3. `tests/test_csprng_uniqueness.sh` – тест уникальности 1000 ключей
4. `tests/generate_nist_data.sh` – генератор данных для NIST STS

### Измененные файлы
1. `main.c` – Автогенерация ключа при шифровании без `--key` через системный CSPRNG (`generate_aes_key()`); интеграция CSPRNG для IV; предупреждения о слабых ключах; удалено использование `mouse_entropy` для генерации ключей
2. `Makefile` – добавлен `src/csprng.c` и линковка `-lcrypto -lbcrypt`; UTF-8 флаги
3. `build.bat` – обновлены флаги UTF-8 и линковка; добавлена компиляция `csprng.c`
4. `README.md` – обновлено поведение CLI, примеры, раздел о CSPRNG, NIST STS; уточнено использование системного CSPRNG

**Примечание**: Модуль `mouse_entropy.c` существует в проекте, но не используется для генерации ключей. Генерация ключей всегда использует системный CSPRNG через OpenSSL `RAND_bytes()` в соответствии с требованием RNG-3.

---

## Примеры использования

### Пример 1: Шифрование с автогенерацией ключа (CTR)
```bash
./cryptocore --algorithm aes --mode ctr --encrypt \
  --input plaintext.txt \
  --output ciphertext.bin
# Вывод: [INFO] Generated random key: 1a2b3c4d5e6f7890fedcba9876543210
```

### Пример 2: Дешифрование с использованием напечатанного ключа
```bash
./cryptocore --algorithm aes --mode ctr --decrypt \
  --key 1a2b3c4d5e6f7890fedcba9876543210 \
  --input ciphertext.bin \
  --output decrypted.txt
```

### Пример 3: Режим CBC с IV (не изменилось)
```bash
./cryptocore --algorithm aes --mode cbc --encrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --input data.txt \
  --output data.enc
# Формат файла: [IV (16 байт)][Шифртекст]
```

---

## Сводка соответствия

- ✅ **STR-1…STR-3:** Структура/README/модуль CSPRNG выполнены  
- ✅ **CLI-1…CLI-5:** Опциональный ключ при шифровании, обязательный при дешифровании; вывод сгенерированного ключа; предупреждения о слабых ключах  
- ✅ **RNG-1…RNG-5:** Выделенный модуль, vetted источник (`RAND_bytes()`), интеграция в ключи и IV  
- ✅ **IV-1…IV-4:** Генерация/запись/чтение IV неизменны и соответствуют Sprint 2  
- ✅ **TEST-1…TEST-3:** Тесты (уникальность, NIST STS подготовка, интероп) обеспечены

---

## Примечания по безопасности
- Использование OpenSSL `RAND_bytes()` обеспечивает криптографически стойкий источник случайности для ключей и IV. `RAND_bytes()` использует системный CSPRNG операционной системы (OS-provided CSPRNG), что соответствует требованию RNG-3.
- Генерация ключей всегда выполняется через системный CSPRNG (`generate_aes_key()` → `generate_random_bytes()` → `RAND_bytes()`), а не через альтернативные источники энтропии.
- Предупреждения о «слабых» ключах помогают избежать тривиальных ключей, но не заменяют полноценную политику управления ключами.
- Требования к IV (уникальность/неповторяемость) соблюдены; IV сохраняется и корректно извлекается.

---

## Критерии приемки

Все обязательные требования Sprint 3 выполнены:
- [x] Выделенный модуль CSPRNG
- [x] Автогенерация ключа при шифровании (при отсутствии `--key`)
- [x] Печать ключа в stdout (1 раз, hex)
- [x] Интеграция CSPRNG в IV и ключи
- [x] Обновление документации и тестов (уникальность/NIST STS)
- [x] Сохранение совместимости и поведения Sprint 2

---

## Заключение

✅ **Спринт 3 полностью завершен**  
Реализован CSPRNG на базе OpenSSL `RAND_bytes()` (системный CSPRNG ОС), обновлен CLI для безопасной автогенерации ключей через системный CSPRNG, обеспечена корректная интеграция с существующей логикой IV и сохранена совместимость с OpenSSL и требованиями предыдущих спринтов. Все требования RNG-3 (использование OS-provided CSPRNG) выполнены.
