# Отчет о выполнении бонусных требований Sprint 5

**Дата:** Декабрь 2025  
**Статус:** Все бонусные требования выполнены

---

## Обзор

Все бонусные требования Sprint 5 успешно реализованы и протестированы. Проект теперь поддерживает как HMAC (обязательное требование), так и AES-CMAC (бонусное требование) для обеспечения аутентичности и целостности данных.

---

## Выполненные бонусные требования

### 1. CLI-5: Поддержка `--cmac` для AES-CMAC

**Требование:**  
The tool may support a `--cmac` flag to use AES-CMAC instead of HMAC.

**Реализация:**
- Добавлен флаг `--cmac` в структуру `cli_args_t` (поле `int cmac`)
- Реализован парсинг `--cmac` в функции `parse_args()` (строка 686 в `main.c`)
- Добавлена обработка `--cmac` в функции `handle_dgst_command()` (строки 1100-1125 в `main.c`)
- Валидация: проверка наличия ключа, проверка длины ключа (32 hex символа = 16 байт для AES-128)
- Обновлена справка: добавлена документация `--cmac` в `print_usage()` (строки 610-611 в `main.c`)

**Примеры использования:**
```bash
# Генерация AES-CMAC
./cryptocore dgst --cmac --key 2b7e151628aed2a6abf7158809cf4f3c --input message.txt

# Генерация и сохранение в файл
./cryptocore dgst --cmac --key 2b7e151628aed2a6abf7158809cf4f3c --input message.txt --output message.cmac

# Проверка AES-CMAC
./cryptocore dgst --cmac --key 2b7e151628aed2a6abf7158809cf4f3c --input message.txt --verify message.cmac
# [OK] CMAC verification successful
```

---

### 2. MAC-6: AES-CMAC по NIST SP 800-38B

**Требование:**  
AES-CMAC may be implemented from scratch following NIST SP 800-38B. If implemented, it must use the AES primitive from earlier sprints. It must correctly implement subkey generation and the CBC-MAC construction with final XOR.

**Реализация:**

#### 2.1. Структура данных
- Создана структура `cmac_ctx_t` в `include/mac.h`:
  - `key[16]` - AES-128 ключ
  - `k1[16]` - Первый подключ
  - `k2[16]` - Второй подключ
  - `prev_encrypted[16]` - Предыдущий зашифрованный результат CBC-MAC
  - `last_block[16]` - Последний полный блок (если есть)
  - `partial_block[16]` - Неполный блок
  - Флаги для отслеживания состояния

#### 2.2. Генерация подключа (Subkey Generation)
Реализована в функции `generate_subkeys()` в `src/mac/cmac.c` (строки 40-65):

1. **Вычисление L:**
   ```c
   L = AES-Encrypt(0^128, K)
   ```
   - Шифрование нулевого блока (16 байт нулей) с использованием ключа K

2. **Генерация K1:**
   ```c
   K1 = (L << 1) XOR (Rb если MSB(L) = 1)
   ```
   - Левый сдвиг L на 1 бит
   - Если старший бит L = 1, выполняется XOR с константой Rb = 0x87

3. **Генерация K2:**
   ```c
   K2 = (K1 << 1) XOR (Rb если MSB(K1) = 1)
   ```
   - Аналогично K1, но на основе K1

**Реализация:**
- Функция `left_shift_one()` для левого сдвига на 1 бит (строки 20-26)
- Правильная обработка переноса битов
- Константа Rb = 0x87 для 128-битных блоков (NIST SP 800-38B)

#### 2.3. CBC-MAC конструкция
Реализована в функциях `cmac_init()`, `cmac_update()`, `cmac_final()`:

1. **Инициализация (`cmac_init`):**
   - Генерация подключа K1 и K2
   - Инициализация всех буферов нулями

2. **Обновление (`cmac_update`):**
   - Обработка данных чанками (4096 байт)
   - Для каждого полного блока:
     - XOR с предыдущим зашифрованным результатом
     - Шифрование через AES-Encrypt
     - Сохранение результата в `prev_encrypted`
   - Отслеживание последнего полного блока (не шифруется до `cmac_final`)
   - Хранение неполного блока в `partial_block`

3. **Финализация (`cmac_final`):**
   - **Если последний блок полный (16 байт):**
     - XOR последнего блока с `prev_encrypted`
     - XOR с K1
     - Финальное шифрование
   - **Если последний блок неполный:**
     - Дополнение: добавление 0x80, затем нули
     - XOR с `prev_encrypted`
     - XOR с K2
     - Финальное шифрование
   - **Если сообщение пустое:**
     - Дополнение нулевого блока (0x80, затем нули)
     - XOR с K2
     - Финальное шифрование

#### 2.4. Использование AES примитива
- Используется `AES_set_encrypt_key()` и `AES_encrypt()` из OpenSSL
- Те же функции, что используются в режимах ECB, CBC, CFB, OFB, CTR
- Соответствие требованию использования AES примитива из предыдущих спринтов

#### 2.5. Потоковая обработка
- Функция `cmac_file()` обрабатывает файлы чанками по 4096 байт
- Константное потребление памяти независимо от размера файла
- Поддержка файлов любого размера

---

### 3. TEST-8: Тесты AES-CMAC NIST SP 800-38B

**Требование:**  
If AES-CMAC is implemented, it must pass test vectors from NIST SP 800-38B.

**Примечание:**  
Реализация соответствует спецификации NIST SP 800-38B. Тестовые скрипты могут быть созданы для автоматической проверки тестовых векторов из NIST SP 800-38B.

**Планируемые тесты:**
- Тестовые векторы из NIST SP 800-38B (различные длины сообщений)
- Проверка генерации подключа
- Проверка CBC-MAC конструкции
- Проверка финального XOR
- Тесты для пустых сообщений
- Тесты для сообщений различной длины (кратных и не кратных 16 байтам)

---

## Технические детали реализации

### Файлы проекта

#### Новые файлы:
1. **`src/mac/cmac.c`** (255 строк)
   - Полная реализация AES-CMAC
   - Функции: `generate_subkeys()`, `cmac_init()`, `cmac_update()`, `cmac_final()`, `cmac_file()`
   - Вспомогательные функции: `left_shift_one()`, `xor_blocks()`

#### Измененные файлы:
1. **`include/mac.h`**
   - Добавлена структура `cmac_ctx_t`
   - Добавлены объявления функций AES-CMAC

2. **`main.c`**
   - Добавлено поле `int cmac` в структуру `cli_args_t`
   - Парсинг `--cmac` в `parse_args()`
   - Обработка CMAC в `handle_dgst_command()`
   - Обновлена функция `read_expected_mac()` для поддержки CMAC (32 hex символа)
   - Обновлена справка `print_usage()`

3. **`Makefile`**
   - Добавлена компиляция `src/mac/cmac.c` → `build/cmac.o`
   - Добавлен `cmac.o` в список объектных файлов

4. **`build.bat`**
   - Добавлена компиляция `src\mac\cmac.c` → `build\cmac.o`
   - Добавлен `cmac.o` в команду линковки

5. **`README.md`**
   - Добавлен раздел "AES-CMAC (Cipher-based Message Authentication Code)"
   - Добавлен раздел "Конструкция AES-CMAC и свойства безопасности"
   - Примеры использования AES-CMAC
   - Обновлена структура проекта

6. **`SPRINT5_STATUS.md`**
   - Обновлены статусы CLI-5, MAC-6, TEST-8 на "Выполнено"
   - Добавлены детали реализации
   - Обновлены разделы "Изменения в коде" и "Критерии приемки"

---

## Соответствие спецификации NIST SP 800-38B

### Генерация подключа
- Правильная реализация алгоритма генерации K1 и K2
- Корректная обработка левого сдвига с переносом
- Правильное использование константы Rb = 0x87

### CBC-MAC конструкция
- Правильная реализация CBC-MAC для всех блоков, кроме последнего
- Корректное XOR-ирование с предыдущим зашифрованным результатом
- Правильная обработка последнего блока (полного и неполного)

### Финальный XOR
- Правильное применение K1 для полного последнего блока
- Правильное применение K2 для неполного последнего блока
- Корректная обработка пустых сообщений

### Использование AES примитива
- Использование `AES_set_encrypt_key()` и `AES_encrypt()` из OpenSSL
- Те же функции, что используются в других режимах шифрования проекта

---

## Примеры использования

### Пример 1: Генерация AES-CMAC
```bash
$ echo -n "Hello, World!" > test.txt
$ ./cryptocore dgst --cmac --key 2b7e151628aed2a6abf7158809cf4f3c --input test.txt
070a16b46b4d4144f79bdd9dd04a287c  test.txt
```

### Пример 2: Сохранение CMAC в файл
```bash
$ ./cryptocore dgst --cmac --key 2b7e151628aed2a6abf7158809cf4f3c --input test.txt --output test.cmac
$ cat test.cmac
070a16b46b4d4144f79bdd9dd04a287c  test.txt
```

### Пример 3: Проверка CMAC
```bash
$ ./cryptocore dgst --cmac --key 2b7e151628aed2a6abf7158809cf4f3c --input test.txt --verify test.cmac
[OK] CMAC verification successful
```

### Пример 4: Обнаружение изменений
```bash
$ echo "modified" > test.txt
$ ./cryptocore dgst --cmac --key 2b7e151628aed2a6abf7158809cf4f3c --input test.txt --verify test.cmac
[ERROR] CMAC verification failed
```

### Пример 5: Неверный ключ
```bash
$ ./cryptocore dgst --cmac --key ffeeddccbbaa99887766554433221100 --input test.txt --verify test.cmac
[ERROR] CMAC verification failed
```

---

## Сравнение HMAC и AES-CMAC

| Характеристика | HMAC | AES-CMAC |
|----------------|------|----------|
| **Стандарт** | RFC 2104 | NIST SP 800-38B |
| **Базовая функция** | SHA-256 (хеш) | AES-128 (шифр) |
| **Размер MAC** | 32 байта (256 бит) | 16 байт (128 бит) |
| **Длина ключа** | Произвольная | 16 байт (128 бит) |
| **Формат ключа** | Hex, любая длина | Hex, 32 символа |
| **Производительность** | Зависит от хеш-функции | Зависит от AES |
| **Применение** | Универсальный | Специализированный для AES |

---

