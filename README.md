# CryptoCore

Консольный криптографический инструмент для шифрования и дешифрования файлов с использованием блочных шифров.

## Возможности

- **Шифрование/дешифрование AES-128** в нескольких режимах работы:
  - **ECB** (Electronic Codebook) - базовый режим
  - **CBC** (Cipher Block Chaining) - цепочка блоков
  - **CFB** (Cipher Feedback) - обратная связь по шифртексту
  - **OFB** (Output Feedback) - обратная связь по выходу
  - **CTR** (Counter) - счетчик
- **Дополнение PKCS#7** для режимов ECB и CBC
- **Автоматическая генерация IV** для режимов с вектором инициализации
- **Безопасная работа с бинарными данными** для текстовых и бинарных файлов
- **Интеграция с OpenSSL** для безопасных криптографических операций AES
- **Совместимость с OpenSSL** - возможность шифровать/дешифровать файлы между CryptoCore и OpenSSL
- **Простой CLI-интерфейс** для легкого шифрования и дешифрования файлов

## Зависимости

Перед сборкой CryptoCore убедитесь, что у вас установлено следующее:

- **Компилятор C**: GCC или Clang
- **Библиотеки разработки OpenSSL**: 
  - На Ubuntu/Debian: `sudo apt-get install libssl-dev`
  - На Fedora/RHEL: `sudo dnf install openssl-devel`
  - На macOS: `brew install openssl` (обычно уже установлен)
  - На Windows: См. [WINDOWS_BUILD.md](WINDOWS_BUILD.md) для подробных инструкций
- **Make**: Инструмент автоматизации сборки (обычно предустановлен на Linux/macOS)

> **Пользователям Windows**: Пожалуйста, прочитайте [WINDOWS_BUILD.md](WINDOWS_BUILD.md) для полных инструкций по сборке на Windows, включая установку OpenSSL и GCC.

## Инструкции по сборке

1. **Клонируйте или скачайте репозиторий**

2. **Перейдите в директорию проекта**:
   ```bash
   cd cryptocore
   ```

3. **Соберите проект**:
   ```bash
   make
   ```

   Это скомпилирует исходный код и создаст исполняемый файл `cryptocore` в текущей директории.

4. **(Опционально) Установите в систему**:
   ```bash
   sudo make install
   ```

   Это установит `cryptocore` в `/usr/local/bin/`, делая его доступным из любого места.

## Использование

### Синтаксис команды

```bash
cryptocore --algorithm АЛГОРИТМ --mode РЕЖИМ [--encrypt|--decrypt] --key КЛЮЧ --input ВХОДНОЙ_ФАЙЛ [--output ВЫХОДНОЙ_ФАЙЛ] [--iv IV]
```

### Обязательные аргументы

- `--algorithm АЛГОРИТМ`: Алгоритм шифрования (поддерживается: `aes`)
- `--mode РЕЖИМ`: Режим работы (`ecb`, `cbc`, `cfb`, `ofb`, `ctr`)
- `--encrypt` или `--decrypt`: Указание операции (требуется ровно один)
- `--key КЛЮЧ`: Ключ шифрования/дешифрования в виде **32-символьной шестнадцатеричной строки** (16 байт для AES-128)
- `--input ФАЙЛ`: Путь к входному файлу

### Опциональные аргументы

- `--output ФАЙЛ`: Путь к выходному файлу
  - Если не указан, по умолчанию:
    - `<входной_файл>.enc` для шифрования
    - `<входной_файл>.dec` для дешифрования
- `--iv IV`: Вектор инициализации (только для дешифрования режимов CBC, CFB, OFB, CTR)
  - 32-символьная шестнадцатеричная строка (16 байт)
  - Если не указан при дешифровании, читается из начала файла

### Режимы работы

#### ECB (Electronic Codebook)
- Самый простой режим
- **Не использует IV**
- Требует дополнение PKCS#7

#### CBC (Cipher Block Chaining)
- Каждый блок шифртекста зависит от предыдущих блоков
- Использует IV для первого блока
- Требует дополнение PKCS#7
- Безопасен для большинства применений

#### CFB (Cipher Feedback)
- Потоковый шифр
- Использует IV
- Не требует дополнения
- Самосинхронизирующийся

#### OFB (Output Feedback)
- Потоковый шифр
- Использует IV
- Не требует дополнения
- Генерирует поток ключа независимо от данных

#### CTR (Counter)
- Потоковый шифр
- Использует IV как начальное значение счетчика
- Не требует дополнения
- Параллелизуемый

### Обработка вектора инициализации (IV)

#### При шифровании (режимы CBC, CFB, OFB, CTR):
- IV генерируется автоматически с использованием криптографически стойкого генератора случайных чисел
- IV добавляется в начало выходного файла
- Формат файла: `[16 байт IV][Шифртекст]`

#### При дешифровании (режимы CBC, CFB, OFB, CTR):
- **Вариант 1**: IV читается из начала входного файла (по умолчанию)
- **Вариант 2**: IV передается явно через `--iv` (для совместимости с OpenSSL)

### Примеры

#### Пример 1: Шифрование в режиме ECB

```bash
cryptocore --algorithm aes --mode ecb --encrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --input plaintext.txt \
  --output ciphertext.bin
```

#### Пример 2: Шифрование в режиме CBC (IV генерируется автоматически)

```bash
cryptocore --algorithm aes --mode cbc --encrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --input plaintext.txt \
  --output ciphertext.bin
```

#### Пример 3: Дешифрование в режиме CBC (IV из файла)

```bash
cryptocore --algorithm aes --mode cbc --decrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --input ciphertext.bin \
  --output decrypted.txt
```

#### Пример 4: Дешифрование в режиме CBC (явный IV для совместимости с OpenSSL)

```bash
cryptocore --algorithm aes --mode cbc --decrypt \
  --key 000102030405060708090a0b0c0d0e0f \
  --iv aabbccddeeff00112233445566778899 \
  --input ciphertext.bin \
  --output decrypted.txt
```

#### Пример 5: Шифрование в режиме CTR

```bash
cryptocore --algorithm aes --mode ctr --encrypt \
  --key 0123456789abcdef0123456789abcdef \
  --input secret.txt \
  --output secret.enc
```

## Тестирование и проверка

### Тест полного цикла

Основной способ проверки корректности - **тест полного цикла**: шифрование файла с последующим дешифрованием должно дать файл, идентичный оригиналу.

```bash
# 1. Создайте тестовый файл
echo "Привет, CryptoCore!" > test.txt

# 2. Зашифруйте файл (CBC режим)
./cryptocore --algorithm aes --mode cbc --encrypt \
  --key 0123456789abcdef0123456789abcdef \
  --input test.txt \
  --output test.enc

# 3. Расшифруйте файл
./cryptocore --algorithm aes --mode cbc --decrypt \
  --key 0123456789abcdef0123456789abcdef \
  --input test.enc \
  --output test_dec.txt

# 4. Проверьте идентичность файлов
diff test.txt test_dec.txt
```

### Совместимость с OpenSSL

CryptoCore полностью совместим с OpenSSL. Вы можете зашифровать файл в CryptoCore и расшифровать в OpenSSL, и наоборот.

#### Шифрование в CryptoCore, дешифрование в OpenSSL

```bash
# 1. Зашифруйте в CryptoCore
./cryptocore --algorithm aes --mode cbc --encrypt \
  --key 0123456789abcdef0123456789abcdef \
  --input plain.txt \
  --output cipher.bin

# 2. Извлеките IV из файла (первые 16 байт)
IV=$(xxd -p -l 16 cipher.bin | tr -d '\n')

# 3. Извлеките шифртекст (все, кроме первых 16 байт)
dd if=cipher.bin of=cipher_only.bin bs=16 skip=1 2>/dev/null

# 4. Расшифруйте в OpenSSL
openssl enc -aes-128-cbc -d \
  -K 0123456789abcdef0123456789abcdef \
  -iv $IV \
  -in cipher_only.bin \
  -out decrypted.txt

# 5. Проверьте
diff plain.txt decrypted.txt
```

#### Шифрование в OpenSSL, дешифрование в CryptoCore

```bash
# 1. Зашифруйте в OpenSSL
openssl enc -aes-128-cbc \
  -K 0123456789abcdef0123456789abcdef \
  -iv aabbccddeeff00112233445566778899 \
  -in plain.txt \
  -out openssl_cipher.bin

# 2. Расшифруйте в CryptoCore
./cryptocore --algorithm aes --mode cbc --decrypt \
  --key 0123456789abcdef0123456789abcdef \
  --iv aabbccddeeff00112233445566778899 \
  --input openssl_cipher.bin \
  --output decrypted.txt

# 3. Проверьте
diff plain.txt decrypted.txt
```

### Автоматизированный тестовый скрипт

Тестовые скрипты находятся в директории `tests/`:

```bash
cd tests
./run_tests.sh              # Для Linux/macOS/MSYS2
./test_openssl_compat.sh    # Тесты совместимости с OpenSSL
```

Для Windows PowerShell:
```powershell
cd tests
.\test_manual.ps1
```

## Структура проекта

```
cryptocore/
├── src/                    # Директория исходного кода
│   ├── ecb.c              # Реализация режима ECB
│   ├── file_io.c          # Операции ввода-вывода файлов
│   └── modes/             # Реализации режимов шифрования
│       ├── cbc.c          # Режим CBC
│       ├── cfb.c          # Режим CFB
│       ├── ofb.c          # Режим OFB
│       ├── ctr.c          # Режим CTR
│       └── utils.c        # Утилиты (XOR, генерация IV)
├── include/               # Заголовочные файлы
│   ├── ecb.h              # Объявления ECB
│   ├── modes.h            # Объявления режимов
│   └── file_io.h          # Объявления ввода-вывода файлов
├── tests/                 # Тестовые файлы и скрипты
│   ├── run_tests.sh       # Автоматизированный тестовый скрипт
│   └── test_openssl_compat.sh  # Тесты совместимости с OpenSSL
├── build/                 # Артефакты сборки (создаются при компиляции)
├── main.c                 # Парсер CLI и основная логика программы
├── Makefile               # Система сборки
└── README.md              # Этот файл
```

## Детали реализации

### AES-128

- **Алгоритм**: AES (Advanced Encryption Standard)
- **Размер ключа**: 128 бит (16 байт)
- **Размер блока**: 128 бит (16 байт)
- **Библиотека**: OpenSSL (libcrypto)

### Режимы и дополнение

| Режим | Требует IV | Требует дополнение | Тип |
|-------|-----------|-------------------|-----|
| ECB   | Нет       | Да (PKCS#7)       | Блочный |
| CBC   | Да        | Да (PKCS#7)       | Блочный |
| CFB   | Да        | Нет               | Потоковый |
| OFB   | Да        | Нет               | Потоковый |
| CTR   | Да        | Нет               | Потоковый |

### Дополнение PKCS#7

Для режимов ECB и CBC используется дополнение PKCS#7:
- Гарантирует, что открытый текст кратен размеру блока (16 байт)
- Каждый байт дополнения содержит количество добавленных байтов дополнения

**Пример**:
- Вход: `"Привет"` (12 байт в UTF-8)
- После дополнения: `"Привет\x04\x04\x04\x04"` (16 байт)

### Примечание о безопасности

**Режим ECB не рекомендуется для производственного использования**, так как он не обеспечивает семантическую безопасность. Идентичные блоки открытого текста производят идентичные блоки шифртекста.

Рекомендуемые режимы для продакшена:
- **CBC** - для общего назначения
- **CTR** - когда требуется параллелизация
- **GCM** - когда требуется аутентификация (будет добавлено в будущих версиях)

## Обработка ошибок

CryptoCore предоставляет четкие сообщения об ошибках:

- **Отсутствующие аргументы**: Указывает, какой обязательный аргумент отсутствует
- **Неверный формат ключа/IV**: Ключ и IV должны быть 32 шестнадцатеричных символа
- **Ошибки файлов**: Четкие сообщения о том, что файл не найден, проблемы с правами доступа и т.д.
- **Неверное дополнение**: Обнаруживает поврежденный или измененный шифртекст
- **Неверный IV**: Проверяет длину и формат IV

Все ошибки выводятся в `stderr`, и программа завершается с ненулевым кодом состояния.

## Сборка на Windows

Для пользователей Windows с MinGW:

```bash
# Установите зависимости (используя MSYS2)
pacman -S mingw-w64-x86_64-gcc mingw-w64-x86_64-openssl make

# Сборка
make
```

Или используйте `build.bat` для Windows без Make.