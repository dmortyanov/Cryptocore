# CryptoCore - Отчет о статусе Спринта 5

**Спринт:** 5  
**Статус:** Завершен  
**Дата:** Ноябрь 2025

## Цель Спринта 5
Реализовать функции для обеспечения аутентичности и целостности данных через HMAC (Message Authentication Code), расширить команду `dgst` для поддержки MAC-операций с ключами.

---

## Контрольный список соответствия требованиям

### 1. Структура проекта и гигиена репозитория

| ID | Требование | Статус | Примечания |
|----|------------|--------|------------|
| STR-1 | Все требования предыдущих спринтов (STR-1…STR-4) выполнены | ✅ Выполнено | Спринты 1–4 сохранены без регрессий |
| STR-2 | Создана структура `src/mac/` для MAC реализаций | ✅ Выполнено | `src/mac/hmac.c`, `include/mac.h` |
| STR-3 | README обновлен требованиями спринта | ✅ Выполнено | README.md (строки 93-153): документация `--hmac`, `--key`, `--verify` для команды `dgst`, примеры генерации и верификации HMAC, раздел "Конструкция HMAC и свойства безопасности" с формулой RFC 2104, обработкой ключей и свойствами безопасности |

### 2. Интерфейс командной строки (CLI)

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| CLI-1 | `dgst` поддерживает флаг `--hmac` | ✅ Выполнено | Парсинг `--hmac` в `parse_args()` (строка 682), обработка в `handle_dgst_command()` (строка 1074), проверка обязательности `--key` при `--hmac` |
| CLI-2 | При `--hmac` аргумент `--key` обязателен | ✅ Выполнено | Проверка `!args->key_hex` в `handle_dgst_command()` (строка 1075), ключ в hex формате произвольной длины, конвертация через `hex_to_bytes()` |
| CLI-3 | Формат вывода HMAC: `HMAC_VALUE INPUT_FILE_PATH` | ✅ Выполнено | Формат с одним пробелом: `printf("%s %s\n", hex_hash, args->input_path)` (строка 1162), совместимо с форматом хешей |
| CLI-4 | Опциональный `--verify FILE` для проверки HMAC | ✅ Выполнено | Парсинг `--verify` в `parse_args()` (строка 684), чтение ожидаемого HMAC через `read_expected_hmac()` (строка 1123), сравнение с учетом регистра, коды возврата: 0 при успехе, 1 при ошибке |
| CLI-5 | (Bonus) Поддержка `--cmac` для AES-CMAC | ✅ Выполнено | Парсинг `--cmac` в `parse_args()` (строка 686), обработка в `handle_dgst_command()` (строка 1100), требует AES-128 ключ (32 hex символа) |

### 3. Реализация HMAC

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| MAC-1 | HMAC реализован с нуля по RFC 2104 | ✅ Выполнено | `src/mac/hmac.c`: полная реализация с использованием SHA-256 из Sprint 4, функции `hmac_init()`, `hmac_update()`, `hmac_final()`, `hmac_file()` |
| MAC-2 | Корректная обработка ключей | ✅ Выполнено | Функция `process_key()` (строка 15): если `key_len > 64` байт - хеширование через SHA-256, если `key_len < 64` байт - дополнение нулями до 64 байт |
| MAC-3 | Правильная формула HMAC(K, m) | ✅ Выполнено | Реализация в `hmac_final()` (строка 94): `H((K ⊕ opad) ∥ H((K ⊕ ipad) ∥ m))`, где opad=0x5c (64 раза), ipad=0x36 (64 раза), XOR через `xor_bytes()` (строка 36) |
| MAC-4 | Поддержка ключей произвольной длины | ✅ Выполнено | Ключ конвертируется из hex через `hex_to_bytes()` (строка 1087), обрабатывается в `process_key()` для любой длины |
| MAC-5 | Потоковая обработка файлов | ✅ Выполнено | В `hmac_file()` (строка 114): чтение файла чанками по 4096 байт в цикле `while ((bytes_read = fread(...)) > 0)`, константное потребление памяти |
| MAC-6 | (Bonus) AES-CMAC по NIST SP 800-38B | ✅ Выполнено | `src/mac/cmac.c`: полная реализация с генерацией подключа (K1, K2), CBC-MAC конструкция с финальным XOR, использование AES примитива из предыдущих спринтов |

### 4. Ввод/вывод для MAC операций

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| IO-1 | Чтение файла в бинарном режиме, обработка чанками | ✅ Выполнено | `hmac_file()` (строка 124): `fopen(filepath, "rb")` для бинарного режима, обработка чанками по 4096 байт в цикле |
| IO-2 | Чтение ожидаемого HMAC из файла при `--verify` | ✅ Выполнено | Функция `read_expected_hmac()` (строка 1017): чтение файла, гибкий парсинг - извлечение первых 64 hex символов, игнорирование пробелов и имени файла |
| IO-3 | `--output` записывает HMAC в стандартном формате | ✅ Выполнено | В `handle_dgst_command()` (строка 1158): `fprintf(f, "%s %s\n", hex_hash, args->input_path)` - формат с одним пробелом, как в CLI-3 |

### 5. Тестирование и проверка

| ID | Требование | Статус | Примечания |
|----|------------|--------|------------|
| TEST-1 | Тесты RFC 4231 (test cases 1-4) | ✅ Выполнено | Реализованы в `tests/test_hmac.sh` (строки 104-163): TEST-1, TEST-2, TEST-3, TEST-4 с проверкой ожидаемых значений из RFC 4231 Section 4.2 |
| TEST-2 | Проверка верификации сгенерированных HMAC | ✅ Выполнено | Реализовано в `tests/test_hmac.sh` (TEST-5, строка 165): генерация HMAC, сохранение в файл, проверка через `--verify` с кодом возврата 0 |
| TEST-3 | Обнаружение изменений в файле | ✅ Выполнено | Реализовано в `tests/test_hmac.sh` (TEST-6, строка 185): генерация HMAC, изменение файла, проверка что `--verify` возвращает код 1 |
| TEST-4 | Обнаружение неверного ключа | ✅ Выполнено | Реализовано в `tests/test_hmac.sh` (TEST-7, строка 205): генерация HMAC с одним ключом, проверка с другим ключом, код возврата 1 |
| TEST-5 | Тесты различных размеров ключей | ✅ Выполнено | Реализовано в `tests/test_hmac.sh` (TEST-8, строка 225): ключи 16 байт (<64), 64 байта (=64), 100 байт (>64), все проходят успешно |
| TEST-6 | Тест пустого файла | ✅ Выполнено | Реализовано в `tests/test_hmac.sh` (TEST-9, строка 245): создание пустого файла, вычисление HMAC, проверка корректности результата |
| TEST-7 | Тест больших файлов | ✅ Выполнено | Реализовано в `tests/test_hmac.sh` (TEST-10, строка 265): создание файла, вычисление HMAC, проверка что обработка проходит успешно |
| TEST-8 | (Bonus) Тесты AES-CMAC NIST SP 800-38B | ✅ Выполнено | Реализованы в `tests/test_cmac.sh` и `tests/test_cmac.ps1`: тестовые векторы из NIST SP 800-38B, проверка генерации подключа, CBC-MAC конструкция |

---

## Тестирование

Все тесты реализованы в `tests/test_hmac.sh` (для Linux/macOS/MSYS2) и `tests/test_hmac.ps1` (для Windows PowerShell).

### Результаты тестирования

Все обязательные тесты (TEST-1 до TEST-7) проходят успешно:

- **TEST-1**: RFC 4231 Test Case 1 - ✓ Проходит
- **TEST-2**: RFC 4231 Test Case 2 - ✓ Проходит  
- **TEST-3**: RFC 4231 Test Case 3 - ✓ Проходит
- **TEST-4**: RFC 4231 Test Case 4 - ✓ Проходит
- **TEST-5**: Верификация сгенерированных HMAC - ✓ Проходит
- **TEST-6**: Обнаружение изменений в файле - ✓ Проходит
- **TEST-7**: Обнаружение неверного ключа - ✓ Проходит
- **TEST-8**: Тесты различных размеров ключей - ✓ Проходит
- **TEST-9**: Тест пустого файла - ✓ Проходит
- **TEST-10**: Тест больших файлов - ✓ Проходит

### Запуск тестов

```bash
# Linux/macOS/MSYS2
cd tests
chmod +x test_hmac.sh
./test_hmac.sh

# Windows PowerShell
cd tests
.\test_hmac.ps1
```

---

## Изменения в коде

### Новые файлы
1. `include/mac.h` – Заголовок HMAC и AES-CMAC
2. `src/mac/hmac.c` – Реализация HMAC с нуля (RFC 2104, SHA-256)
3. `src/mac/cmac.c` – Реализация AES-CMAC с нуля (NIST SP 800-38B, AES-128)

### Измененные файлы
1. `main.c` – Расширен парсинг для `--hmac`, `--cmac`, `--key`, `--verify`; обновлена `handle_dgst_command()` для поддержки HMAC и AES-CMAC; добавлена функция `read_expected_mac()` (поддержка HMAC и CMAC); формат вывода с одним пробелом
2. `Makefile` – добавлена компиляция `src/mac/hmac.c` и `src/mac/cmac.c`
3. `build.bat` – добавлена компиляция `src/mac/hmac.c` и `src/mac/cmac.c`
4. `README.md` – обновлена документация: раздел HMAC, примеры генерации и верификации, раздел "Конструкция HMAC и свойства безопасности" с формулой RFC 2104; добавлена документация AES-CMAC

### Новые тестовые файлы
1. `tests/test_hmac.sh` – Автоматизированные тесты HMAC для Linux/macOS/MSYS2 (10 тестов: RFC 4231, верификация, обнаружение изменений, различные размеры ключей, пустые и большие файлы)
2. `tests/test_hmac.ps1` – Автоматизированные тесты HMAC для Windows PowerShell (аналогичные тесты)
3. `tests/test_cmac.sh` – Автоматизированные тесты AES-CMAC для Linux/macOS/MSYS2 (тестовые векторы NIST SP 800-38B)
4. `tests/test_cmac.ps1` – Автоматизированные тесты AES-CMAC для Windows PowerShell (аналогичные тесты)

---

## Примеры использования

### Пример 1: Генерация HMAC
```bash
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input message.txt
# Вывод: a1b2c3d4e5f6012345678901234567890123456789012345678901234567890123  message.txt
```

### Пример 2: Генерация HMAC и сохранение в файл
```bash
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input message.txt \
  --output message.hmac
```

### Пример 3: Проверка HMAC
```bash
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input message.txt \
  --verify message.hmac
# Вывод: [OK] HMAC verification successful
```

### Пример 4: Тест RFC 4231 (test case 1)
```bash
echo -n "Hi There" > test_file.txt
./cryptocore dgst --algorithm sha256 --hmac \
  --key 0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b \
  --input test_file.txt
# Ожидаемый результат: b0344c61d8db38535ca8afceaf0bf12b881dc200c9833da726e9376c2e32cff7
```

### Пример 5: Обнаружение изменений
```bash
# Генерация HMAC
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input file.txt > original_hmac.txt

# Изменение файла
echo "modified" > file.txt

# Попытка верификации (должна завершиться ошибкой)
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input file.txt --verify original_hmac.txt
# Вывод: [ERROR] HMAC verification failed
# Код возврата: 1
```

---

## Сводка соответствия

- ✅ **STR-1…STR-3:** Структура/README/модуль MAC выполнены  
- ✅ **CLI-1…CLI-5:** Поддержка `--hmac`, `--cmac`, обязательный `--key`, формат вывода, `--verify`  
- ✅ **MAC-1…MAC-6:** HMAC с нуля по RFC 2104, AES-CMAC с нуля по NIST SP 800-38B, обработка ключей, правильная формула, произвольная длина ключей (HMAC), потоковая обработка  
- ✅ **IO-1…IO-3:** Бинарный режим, чанки, чтение ожидаемого MAC (HMAC/CMAC), `--output`  
- ✅ **TEST-1…TEST-8:** Тесты RFC 4231, верификация, обнаружение изменений, различные размеры ключей, пустые и большие файлы, тесты NIST SP 800-38B для AES-CMAC

---

## Примечания по безопасности

- HMAC обеспечивает аутентификацию и целостность данных через секретный ключ.
- Реализация следует RFC 2104, используя SHA-256 из Sprint 4 как базовую хеш-функцию.
- Обработка ключей корректна: длинные ключи хешируются, короткие дополняются нулями.
- Потоковая обработка позволяет обрабатывать файлы любого размера без загрузки в память целиком.
- HMAC защищает от подделки сообщений: любое изменение данных или использование неверного ключа будет обнаружено.

---

## Критерии приемки

Все обязательные требования Sprint 5 выполнены:
- Выделенный модуль HMAC (`src/mac/hmac.c`)
- Реализация HMAC с нуля по RFC 2104
- Поддержка `--hmac`, `--key`, `--verify` в команде `dgst`
- Корректная обработка ключей произвольной длины
- Потоковая обработка файлов (константное потребление памяти)
- Обновление документации и примеров
- Сохранение совместимости и поведения предыдущих спринтов

Все бонусные требования Sprint 5 выполнены:
- Выделенный модуль AES-CMAC (`src/mac/cmac.c`)
- Реализация AES-CMAC с нуля по NIST SP 800-38B
- Поддержка `--cmac` в команде `dgst`
- Генерация подключа (K1, K2) согласно NIST SP 800-38B
- CBC-MAC конструкция с финальным XOR
- Использование AES примитива из предыдущих спринтов
- Тесты NIST SP 800-38B для AES-CMAC

