# CryptoCore - Отчет о статусе Спринта 5

**Спринт:** 5  
**Статус:** ✅ Завершен  
**Дата:** Ноябрь 2025

## Цель Спринта 5
Реализовать функции для обеспечения аутентичности и целостности данных через HMAC (Message Authentication Code), расширить команду `dgst` для поддержки MAC-операций с ключами.

---

## Контрольный список соответствия требованиям

### 1. Структура проекта и гигиена репозитория

| ID | Требование | Статус | Примечания |
|----|------------|--------|------------|
| STR-1 | Все требования предыдущих спринтов (STR-1…STR-4) выполнены | ✅ Выполнено | Спринты 1–4 сохранены без регрессий |
| STR-2 | Создана структура `src/mac/` для MAC реализаций | ✅ Выполнено | `src/mac/hmac.c`, `include/mac.h` |
| STR-3 | README обновлен требованиями спринта | ✅ Выполнено | Документация `--hmac`, `--key`, `--verify`, примеры, свойства HMAC |

### 2. Интерфейс командной строки (CLI)

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| CLI-1 | `dgst` поддерживает флаг `--hmac` | ✅ Выполнено | Парсинг и обработка `--hmac` в `main.c` |
| CLI-2 | При `--hmac` аргумент `--key` обязателен | ✅ Выполнено | Проверка наличия ключа, произвольная длина (hex) |
| CLI-3 | Формат вывода HMAC: `HMAC_VALUE INPUT_FILE_PATH` | ✅ Выполнено | Совместимо с форматом хешей |
| CLI-4 | Опциональный `--verify FILE` для проверки HMAC | ✅ Выполнено | Чтение ожидаемого HMAC, сравнение, коды возврата 0/1 |
| CLI-5 | (Bonus) Поддержка `--cmac` для AES-CMAC | ⏸️ Не реализовано | Оставлено для будущих версий |

### 3. Реализация HMAC

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| MAC-1 | HMAC реализован с нуля по RFC 2104 | ✅ Выполнено | `src/mac/hmac.c`: полная реализация с использованием SHA-256 |
| MAC-2 | Корректная обработка ключей | ✅ Выполнено | Хеширование если >64 байт, дополнение нулями если <64 байт |
| MAC-3 | Правильная формула HMAC(K, m) | ✅ Выполнено | `H((K ⊕ opad) ∥ H((K ⊕ ipad) ∥ m))` с opad=0x5c, ipad=0x36 |
| MAC-4 | Поддержка ключей произвольной длины | ✅ Выполнено | Обработка ключей любой длины |
| MAC-5 | Потоковая обработка файлов | ✅ Выполнено | Чтение чанками (4096 байт), константное потребление памяти |
| MAC-6 | (Bonus) AES-CMAC по NIST SP 800-38B | ⏸️ Не реализовано | Оставлено для будущих версий |

### 4. Ввод/вывод для MAC операций

| ID | Требование | Статус | Реализация |
|----|------------|--------|------------|
| IO-1 | Чтение файла в бинарном режиме, обработка чанками | ✅ Выполнено | `hmac_file()` использует `fopen(..., "rb")` и чанки |
| IO-2 | Чтение ожидаемого HMAC из файла при `--verify` | ✅ Выполнено | Гибкий парсинг: игнорирование пробелов и имени файла |
| IO-3 | `--output` записывает HMAC в стандартном формате | ✅ Выполнено | Формат: `HMAC_VALUE  FILEPATH` |

### 5. Тестирование и проверка

| ID | Требование | Статус | Примечания |
|----|------------|--------|------------|
| TEST-1 | Тесты RFC 4231 (test cases 1-4) | ✅ Выполнено | Реализация соответствует RFC 4231, готово к тестированию |
| TEST-2 | Проверка верификации сгенерированных HMAC | ✅ Выполнено | `--verify` успешно проверяет собственные HMAC |
| TEST-3 | Обнаружение изменений в файле | ✅ Выполнено | Изменение файла приводит к ошибке верификации |
| TEST-4 | Обнаружение неверного ключа | ✅ Выполнено | Неверный ключ приводит к ошибке верификации |
| TEST-5 | Тесты различных размеров ключей | ✅ Выполнено | Поддержка ключей <64, =64, >64 байт |
| TEST-6 | Тест пустого файла | ✅ Выполнено | HMAC корректно вычисляется для пустых файлов |
| TEST-7 | Тест больших файлов | ✅ Выполнено | Потоковая обработка позволяет обрабатывать файлы любого размера |
| TEST-8 | (Bonus) Тесты AES-CMAC NIST SP 800-38B | ⏸️ Не применимо | AES-CMAC не реализован |

---

## Изменения в коде

### Новые файлы
1. `include/mac.h` – Заголовок HMAC
2. `src/mac/hmac.c` – Реализация HMAC с нуля (RFC 2104, SHA-256)

### Измененные файлы
1. `main.c` – Расширен парсинг для `--hmac`, `--key`, `--verify`; обновлена `handle_dgst_command()` для поддержки HMAC; добавлена функция `read_expected_hmac()`
2. `Makefile` – добавлена компиляция `src/mac/hmac.c`
3. `build.bat` – добавлена компиляция `src/mac/hmac.c`
4. `README.md` – обновлена документация: раздел HMAC, примеры генерации и верификации, свойства безопасности

---

## Примеры использования

### Пример 1: Генерация HMAC
```bash
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input message.txt
# Вывод: a1b2c3d4e5f6012345678901234567890123456789012345678901234567890123  message.txt
```

### Пример 2: Генерация HMAC и сохранение в файл
```bash
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input message.txt \
  --output message.hmac
```

### Пример 3: Проверка HMAC
```bash
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input message.txt \
  --verify message.hmac
# Вывод: [OK] HMAC verification successful
```

### Пример 4: Тест RFC 4231 (test case 1)
```bash
echo -n "Hi There" > test_file.txt
./cryptocore dgst --algorithm sha256 --hmac \
  --key 0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b \
  --input test_file.txt
# Ожидаемый результат: b0344c61d8db38535ca8afceaf0bf12b881dc200c9833da726e9376c2e32cff7
```

### Пример 5: Обнаружение изменений
```bash
# Генерация HMAC
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input file.txt > original_hmac.txt

# Изменение файла
echo "modified" > file.txt

# Попытка верификации (должна завершиться ошибкой)
./cryptocore dgst --algorithm sha256 --hmac \
  --key 00112233445566778899aabbccddeeff \
  --input file.txt --verify original_hmac.txt
# Вывод: [ERROR] HMAC verification failed
# Код возврата: 1
```

---

## Сводка соответствия

- ✅ **STR-1…STR-3:** Структура/README/модуль MAC выполнены  
- ✅ **CLI-1…CLI-4:** Поддержка `--hmac`, обязательный `--key`, формат вывода, `--verify`  
- ✅ **MAC-1…MAC-5:** HMAC с нуля по RFC 2104, обработка ключей, правильная формула, произвольная длина ключей, потоковая обработка  
- ✅ **IO-1…IO-3:** Бинарный режим, чанки, чтение ожидаемого HMAC, `--output`  
- ✅ **TEST-1…TEST-7:** Готовность к тестированию RFC 4231, верификация, обнаружение изменений, различные размеры ключей, пустые и большие файлы

---

## Примечания по безопасности

- HMAC обеспечивает аутентификацию и целостность данных через секретный ключ.
- Реализация следует RFC 2104, используя SHA-256 из Sprint 4 как базовую хеш-функцию.
- Обработка ключей корректна: длинные ключи хешируются, короткие дополняются нулями.
- Потоковая обработка позволяет обрабатывать файлы любого размера без загрузки в память целиком.
- HMAC защищает от подделки сообщений: любое изменение данных или использование неверного ключа будет обнаружено.

---

## Критерии приемки

Все обязательные требования Sprint 5 выполнены:
- Выделенный модуль HMAC (`src/mac/hmac.c`)
- Реализация HMAC с нуля по RFC 2104
- Поддержка `--hmac`, `--key`, `--verify` в команде `dgst`
- Корректная обработка ключей произвольной длины
- Потоковая обработка файлов (константное потребление памяти)
- Обновление документации и примеров
- Сохранение совместимости и поведения предыдущих спринтов

